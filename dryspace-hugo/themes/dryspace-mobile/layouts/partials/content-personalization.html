<!-- Dynamic Content Personalization System - Sophia Rodriguez Implementation -->
<section class="personalized-content-section py-5 bg-white" id="personalized-experience">
    <div class="container">
        <!-- Personalized Hero Message -->
        <div class="personalized-hero mb-5">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="dynamic-greeting mb-3">
                        <h2 class="display-6 fw-bold" id="personalizedHeading">
                            <!-- Dynamic heading based on user context -->
                        </h2>
                        <p class="lead text-muted" id="personalizedSubheading">
                            <!-- Dynamic subheading based on user journey -->
                        </p>
                    </div>
                </div>
                <div class="col-lg-4 text-lg-end">
                    <div class="user-context-badge">
                        <span class="badge bg-primary px-3 py-2" id="userContextBadge">
                            <i class="fas fa-user me-2"></i>
                            <span id="userContextText">New Visitor</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Content Blocks -->
        <div class="row g-4" id="dynamicContentBlocks">
            <!-- Content blocks inserted dynamically based on user behavior -->
        </div>

        <!-- Smart Recommendations -->
        <div class="smart-recommendations mt-5" id="smartRecommendations" style="display: none;">
            <h3 class="h4 mb-4">
                <i class="fas fa-brain text-primary me-2"></i>
                Based on Your Interests
            </h3>
            <div class="row g-3" id="recommendationCards">
                <!-- Dynamic recommendations -->
            </div>
        </div>

        <!-- Behavioral Triggers -->
        <div class="behavioral-triggers" id="behavioralTriggers">
            <!-- Exit intent popup -->
            <div class="exit-intent-content d-none" id="exitIntentContent">
                <div class="card shadow-lg border-0">
                    <div class="card-body p-4">
                        <h4 class="mb-3">Wait! Before You Go...</h4>
                        <p>Get our free basement waterproofing guide - it could save you thousands!</p>
                        <form class="exit-capture-form">
                            <div class="input-group">
                                <input type="email" class="form-control" placeholder="Enter your email">
                                <button class="btn btn-primary" type="submit">
                                    Get Free Guide
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Time-based engagement -->
            <div class="time-based-offer d-none" id="timeBasedOffer">
                <div class="alert alert-info alert-dismissible fade show">
                    <h5 class="alert-heading">
                        <i class="fas fa-gift me-2"></i>Special Offer
                    </h5>
                    <p class="mb-0">You've been researching for <span id="researchTime">5</span> minutes. 
                    Ready to talk to an expert? Get 10% off your consultation!</p>
                    <hr>
                    <button class="btn btn-info btn-sm">Claim Offer</button>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>

            <!-- Scroll depth trigger -->
            <div class="scroll-depth-cta d-none" id="scrollDepthCTA">
                <div class="position-fixed bottom-0 end-0 m-4" style="z-index: 1040;">
                    <div class="card shadow-lg" style="width: 300px;">
                        <div class="card-body">
                            <h6 class="card-title">You're Learning a Lot!</h6>
                            <p class="card-text small">Ready to put this knowledge to use?</p>
                            <a href="#waterproofing-calculator" class="btn btn-primary btn-sm w-100">
                                Try Our Calculator
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Journey Map -->
        <div class="content-journey-map mt-5 d-none" id="contentJourneyMap">
            <h4 class="h5 mb-3">Your Learning Path</h4>
            <div class="journey-progress">
                <div class="d-flex justify-content-between position-relative">
                    <div class="journey-step completed" data-step="awareness">
                        <div class="step-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <small>Research</small>
                    </div>
                    <div class="journey-step active" data-step="consideration">
                        <div class="step-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <small>Compare</small>
                    </div>
                    <div class="journey-step" data-step="decision">
                        <div class="step-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <small>Decide</small>
                    </div>
                    <div class="journey-step" data-step="action">
                        <div class="step-icon">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <small>Act</small>
                    </div>
                    <div class="journey-line"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Floating Engagement Widget -->
<div class="engagement-widget" id="engagementWidget">
    <button class="widget-trigger" id="widgetTrigger">
        <i class="fas fa-comments"></i>
        <span class="widget-badge">1</span>
    </button>
    <div class="widget-content" id="widgetContent">
        <div class="widget-header">
            <h6 class="mb-0">Quick Question?</h6>
            <button class="btn-close btn-close-white" onclick="closeWidget()"></button>
        </div>
        <div class="widget-body">
            <div class="quick-questions">
                <button class="btn btn-sm btn-outline-light w-100 mb-2" onclick="askQuestion('cost')">
                    How much does it cost?
                </button>
                <button class="btn btn-sm btn-outline-light w-100 mb-2" onclick="askQuestion('time')">
                    How long does it take?
                </button>
                <button class="btn btn-sm btn-outline-light w-100" onclick="askQuestion('warranty')">
                    What's the warranty?
                </button>
            </div>
            <div class="question-answer d-none" id="questionAnswer">
                <!-- Dynamic answer content -->
            </div>
        </div>
    </div>
</div>

<style>
/* Personalization Styles */
.personalized-hero {
    position: relative;
}

.user-context-badge {
    animation: fadeIn 0.5s ease;
}

.dynamic-greeting h2 {
    transition: all 0.5s ease;
}

/* Content Blocks */
.content-block-card {
    opacity: 0;
    animation: slideUp 0.6s ease forwards;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Journey Map */
.journey-step {
    position: relative;
    z-index: 2;
    text-align: center;
    flex: 1;
}

.step-icon {
    width: 50px;
    height: 50px;
    background: #e9ecef;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    transition: all 0.3s ease;
}

.journey-step.completed .step-icon {
    background: #28a745;
    color: white;
}

.journey-step.active .step-icon {
    background: #0d6efd;
    color: white;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(13, 110, 253, 0); }
    100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
}

.journey-line {
    position: absolute;
    top: 25px;
    left: 10%;
    right: 10%;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}

/* Engagement Widget */
.engagement-widget {
    position: fixed;
    bottom: 100px;
    right: 20px;
    z-index: 1050;
}

.widget-trigger {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #0d6efd;
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    position: relative;
    transition: all 0.3s ease;
}

.widget-trigger:hover {
    transform: scale(1.1);
}

.widget-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
}

.widget-content {
    position: absolute;
    bottom: 70px;
    right: 0;
    width: 300px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: none;
}

.widget-content.show {
    display: block;
    animation: slideInUp 0.3s ease;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.widget-header {
    background: #0d6efd;
    color: white;
    padding: 1rem;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.widget-body {
    padding: 1rem;
}

/* Behavioral Triggers */
.exit-intent-content,
.time-based-offer,
.scroll-depth-cta {
    animation: fadeIn 0.5s ease;
}

/* Mobile Optimization */
@media (max-width: 768px) {
    .engagement-widget {
        bottom: 70px;
        right: 10px;
    }
    
    .widget-content {
        width: calc(100vw - 40px);
        right: -10px;
    }
    
    .journey-step small {
        font-size: 0.7rem;
    }
    
    .step-icon {
        width: 40px;
        height: 40px;
    }
}
</style>

<script>
// Content Personalization Engine
class ContentPersonalization {
    constructor() {
        this.userData = {
            visitCount: parseInt(localStorage.getItem('visitCount') || '0') + 1,
            lastVisit: localStorage.getItem('lastVisit'),
            interests: JSON.parse(localStorage.getItem('interests') || '[]'),
            stage: localStorage.getItem('userStage') || 'awareness',
            timeOnSite: 0,
            scrollDepth: 0,
            interactions: []
        };
        
        this.init();
    }

    init() {
        // Update visit data
        localStorage.setItem('visitCount', this.userData.visitCount);
        localStorage.setItem('lastVisit', new Date().toISOString());
        
        // Personalize content
        this.personalizeHeading();
        this.loadDynamicContent();
        this.setupBehavioralTriggers();
        this.trackUserBehavior();
        
        // Show journey map for returning visitors
        if (this.userData.visitCount > 1) {
            document.getElementById('contentJourneyMap').classList.remove('d-none');
        }
    }

    personalizeHeading() {
        const heading = document.getElementById('personalizedHeading');
        const subheading = document.getElementById('personalizedSubheading');
        const contextBadge = document.getElementById('userContextText');
        
        if (this.userData.visitCount === 1) {
            heading.textContent = "Welcome! Let's Solve Your Basement Water Problems";
            subheading.textContent = "Discover why Toronto homeowners trust Dryspace for permanent waterproofing solutions";
            contextBadge.textContent = "First Time Visitor";
        } else if (this.userData.visitCount < 5) {
            heading.textContent = "Welcome Back! Ready to Take the Next Step?";
            subheading.textContent = "Continue exploring our waterproofing solutions or get your personalized quote";
            contextBadge.textContent = "Returning Visitor";
            
            // Show recommendations
            document.getElementById('smartRecommendations').style.display = 'block';
            this.loadRecommendations();
        } else {
            heading.textContent = "Great to See You Again! Let's Get Your Project Started";
            subheading.textContent = "You've done your research - now let's protect your home together";
            contextBadge.textContent = "Valued Customer";
            
            // Show special offers
            this.showLoyaltyOffer();
        }
    }

    loadDynamicContent() {
        const container = document.getElementById('dynamicContentBlocks');
        const stage = this.userData.stage;
        
        const contentMap = {
            awareness: [
                {
                    icon: 'fa-question-circle',
                    title: 'New to Waterproofing?',
                    content: 'Start with our beginner\'s guide to understand the basics',
                    cta: 'Learn the Basics',
                    link: '#content-hub'
                },
                {
                    icon: 'fa-calculator',
                    title: 'Estimate Your Investment',
                    content: 'Use our smart calculator to get instant pricing',
                    cta: 'Calculate Cost',
                    link: '#waterproofing-calculator'
                },
                {
                    icon: 'fa-book',
                    title: 'Success Stories',
                    content: 'See how we\'ve helped 50,000+ Toronto homes',
                    cta: 'View Case Studies',
                    link: '#case-studies'
                }
            ],
            consideration: [
                {
                    icon: 'fa-balance-scale',
                    title: 'Compare Solutions',
                    content: 'Interior vs exterior waterproofing - which is right for you?',
                    cta: 'Compare Options',
                    link: '#solutions-comparison'
                },
                {
                    icon: 'fa-star',
                    title: 'Why Choose Dryspace?',
                    content: 'See our advantages over other contractors',
                    cta: 'View Comparison',
                    link: '#why-choose'
                },
                {
                    icon: 'fa-comments',
                    title: 'Talk to Past Customers',
                    content: 'Read verified reviews from your neighborhood',
                    cta: 'Read Reviews',
                    link: '#testimonials'
                }
            ],
            decision: [
                {
                    icon: 'fa-phone',
                    title: 'Ready to Talk?',
                    content: 'Schedule a free consultation with our experts',
                    cta: 'Book Consultation',
                    link: 'tel:4375450067'
                },
                {
                    icon: 'fa-file-invoice-dollar',
                    title: 'Financing Options',
                    content: 'Flexible payment plans starting at $89/month',
                    cta: 'View Financing',
                    link: '#financing'
                },
                {
                    icon: 'fa-shield-alt',
                    title: 'Our Guarantees',
                    content: 'Lifetime warranty and satisfaction guarantee',
                    cta: 'View Warranties',
                    link: '#guarantees'
                }
            ]
        };
        
        const blocks = contentMap[stage] || contentMap.awareness;
        
        container.innerHTML = blocks.map((block, index) => `
            <div class="col-md-4">
                <div class="card h-100 content-block-card" style="animation-delay: ${index * 0.1}s">
                    <div class="card-body text-center">
                        <i class="fas ${block.icon} text-primary fs-1 mb-3"></i>
                        <h5 class="card-title">${block.title}</h5>
                        <p class="card-text">${block.content}</p>
                        <a href="${block.link}" class="btn btn-primary btn-sm">${block.cta}</a>
                    </div>
                </div>
            </div>
        `).join('');
    }

    loadRecommendations() {
        const container = document.getElementById('recommendationCards');
        
        // Smart recommendations based on behavior
        const recommendations = [
            {
                title: 'Spring Flooding Guide',
                description: 'Prepare for Toronto\'s wet season',
                type: 'guide',
                urgency: 'high'
            },
            {
                title: 'Cost Calculator',
                description: 'Get instant pricing for your project',
                type: 'tool',
                urgency: 'medium'
            },
            {
                title: '10-Point Basement Check',
                description: 'DIY inspection checklist',
                type: 'checklist',
                urgency: 'low'
            }
        ];
        
        container.innerHTML = recommendations.map(rec => `
            <div class="col-md-4">
                <div class="card recommendation-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${rec.title}</h6>
                            ${rec.urgency === 'high' ? '<span class="badge bg-danger">Urgent</span>' : ''}
                        </div>
                        <p class="card-text small text-muted">${rec.description}</p>
                        <a href="#" class="btn btn-sm btn-outline-primary">View</a>
                    </div>
                </div>
            </div>
        `).join('');
    }

    setupBehavioralTriggers() {
        // Exit intent
        document.addEventListener('mouseleave', (e) => {
            if (e.clientY <= 0 && !sessionStorage.getItem('exitIntentShown')) {
                this.showExitIntent();
                sessionStorage.setItem('exitIntentShown', 'true');
            }
        });
        
        // Time-based trigger
        setTimeout(() => {
            if (!sessionStorage.getItem('timeOfferShown')) {
                document.getElementById('timeBasedOffer').classList.remove('d-none');
                sessionStorage.setItem('timeOfferShown', 'true');
            }
        }, 300000); // 5 minutes
        
        // Scroll depth trigger
        let scrollTriggered = false;
        window.addEventListener('scroll', () => {
            const scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
            
            if (scrollPercent > 50 && !scrollTriggered) {
                scrollTriggered = true;
                this.showScrollCTA();
            }
            
            this.userData.scrollDepth = Math.max(this.userData.scrollDepth, scrollPercent);
        });
    }

    trackUserBehavior() {
        // Track time on site
        setInterval(() => {
            this.userData.timeOnSite++;
            
            // Update stage based on behavior
            if (this.userData.timeOnSite > 180 && this.userData.stage === 'awareness') {
                this.userData.stage = 'consideration';
                localStorage.setItem('userStage', 'consideration');
            }
        }, 1000);
        
        // Track interactions
        document.addEventListener('click', (e) => {
            if (e.target.matches('a, button')) {
                this.userData.interactions.push({
                    element: e.target.textContent,
                    time: new Date().toISOString()
                });
                
                // Save interests
                if (e.target.href && e.target.href.includes('#')) {
                    const interest = e.target.href.split('#')[1];
                    if (!this.userData.interests.includes(interest)) {
                        this.userData.interests.push(interest);
                        localStorage.setItem('interests', JSON.stringify(this.userData.interests));
                    }
                }
            }
        });
    }

    showExitIntent() {
        const exitContent = document.getElementById('exitIntentContent');
        exitContent.classList.remove('d-none');
        
        // Create modal overlay
        const overlay = document.createElement('div');
        overlay.className = 'modal-backdrop fade show';
        document.body.appendChild(overlay);
        
        // Position exit intent
        exitContent.style.position = 'fixed';
        exitContent.style.top = '50%';
        exitContent.style.left = '50%';
        exitContent.style.transform = 'translate(-50%, -50%)';
        exitContent.style.zIndex = '1060';
        
        // Close handler
        overlay.addEventListener('click', () => {
            exitContent.classList.add('d-none');
            overlay.remove();
        });
    }

    showScrollCTA() {
        const scrollCTA = document.getElementById('scrollDepthCTA');
        scrollCTA.classList.remove('d-none');
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
            scrollCTA.style.display = 'none';
        }, 10000);
    }

    showLoyaltyOffer() {
        // Special offer for frequent visitors
        const offer = document.createElement('div');
        offer.className = 'alert alert-success alert-dismissible fade show mb-4';
        offer.innerHTML = `
            <h5 class="alert-heading">
                <i class="fas fa-gift me-2"></i>Exclusive Offer for You!
            </h5>
            <p>As a valued returning visitor, enjoy 15% off your waterproofing project + priority scheduling.</p>
            <hr>
            <a href="tel:4375450067" class="btn btn-success">Claim Your Discount</a>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.querySelector('.personalized-hero').appendChild(offer);
    }
}

// Engagement Widget Functions
document.getElementById('widgetTrigger').addEventListener('click', function() {
    const content = document.getElementById('widgetContent');
    content.classList.toggle('show');
});

function closeWidget() {
    document.getElementById('widgetContent').classList.remove('show');
}

function askQuestion(type) {
    const answers = {
        cost: {
            title: 'Waterproofing Costs',
            content: 'Interior waterproofing: $3,000-$7,000<br>Exterior waterproofing: $8,000-$15,000<br><br>Get exact pricing with our calculator!',
            cta: 'Try Calculator'
        },
        time: {
            title: 'Project Timeline',
            content: 'Most projects complete in 2-5 days.<br>• Interior: 2-3 days<br>• Exterior: 4-5 days<br>• Emergency: Same day',
            cta: 'Schedule Now'
        },
        warranty: {
            title: 'Our Warranty',
            content: 'Lifetime transferable warranty on all major waterproofing systems. Covers materials and workmanship forever!',
            cta: 'Learn More'
        }
    };
    
    const answer = answers[type];
    const answerDiv = document.getElementById('questionAnswer');
    
    answerDiv.innerHTML = `
        <h6>${answer.title}</h6>
        <p class="small mb-2">${answer.content}</p>
        <button class="btn btn-primary btn-sm w-100">${answer.cta}</button>
    `;
    
    document.querySelector('.quick-questions').style.display = 'none';
    answerDiv.classList.remove('d-none');
    
    // Track engagement
    if (typeof gtag !== 'undefined') {
        gtag('event', 'widget_question', {
            'question_type': type
        });
    }
}

// Initialize personalization
document.addEventListener('DOMContentLoaded', () => {
    new ContentPersonalization();
});
</script>